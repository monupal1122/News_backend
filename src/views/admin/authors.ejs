<%- include('../partials/header') %>
    <div class="container-fluid p-0">
        <%- include('../partials/sidebar', { activePage: 'authors' }) %>
            <main>
                <header class="main-header mb-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 fw-bold mb-1">Author Management</h1>
                        <p class="text-muted small mb-0">Manage platform contributors and administrators</p>
                    </div>
                    <% if (admin.role==='admin' ) { %>
                        <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#addAuthorModal">
                            <i class="bi bi-person-plus me-2"></i>Add New Author
                        </button>
                        <% } %>
                </header>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Author Profile</th>
                                    <th>Role</th>
                                    <th>Bio Coverage</th>
                                    <th>Joined Date</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% authors.forEach(user=> { %>
                                    <tr id="row-<%= user._id %>">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="position-relative">
                                                    <% if(user.profileImage) { %>
                                                        <img src="<%= user.profileImage %>"
                                                            class="rounded-circle border border-2 border-white shadow-sm"
                                                            width="45" height="45" style="object-fit: cover;">
                                                        <% } else { %>
                                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border border-2 border-white shadow-sm"
                                                                style="width: 45px; height: 45px;">
                                                                <i class="bi bi-person text-muted fs-5"></i>
                                                            </div>
                                                            <% } %>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">
                                                        <%= user.name || 'Anonymous' %>
                                                    </div>
                                                    <div class="text-muted small">
                                                        <%= user.email %>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span
                                                class="badge rounded-pill <%= user.role === 'admin' ? 'bg-primary' : 'bg-success' %> px-3">
                                                <%= user.role.toUpperCase() %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-muted small text-truncate" style="max-width: 200px;">
                                                <%= user.bio ? user.bio : 'No bio provided' %>
                                            </div>
                                        </td>
                                        <td class="text-muted small">
                                            <%= new Date(user.createdAt).toLocaleDateString(undefined, { year: 'numeric'
                                                , month: 'short' , day: 'numeric' }) %>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="d-flex justify-content-end gap-2">
                                                <% if (admin.role==='admin' ) { %>
                                                    <a href="/admin/authors/<%= user._id %>/articles"
                                                        class="btn btn-sm btn-light border" title="View Articles">
                                                        <i class="bi bi-journal-text me-1"></i>Articles
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-primary"
                                                        data-json="<%= JSON.stringify({id: user._id, name: user.name || '', role: user.role, bio: user.bio || ''}) %>"
                                                        onclick="openEditAuthorModal(this)">
                                                        <i class="bi bi-pencil-square"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger"
                                                        onclick="deleteAuthor('<%= user._id %>')"
                                                        <%=admin._id.toString()===user._id.toString() ? 'disabled' : ''
                                                        %>>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    <% } else { %>
                                                        <span class="text-muted smaller">View Only</span>
                                                        <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
    </div>

    <!-- Add Author Modal -->
    <div class="modal fade" id="addAuthorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Create New Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addAuthorForm">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Full Name</label>
                            <input type="text" name="name" class="form-control" required placeholder="e.g. John Doe">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Email Address</label>
                            <input type="email" name="email" class="form-control" required
                                placeholder="john@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Password</label>
                            <input type="password" name="password" class="form-control" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Role</label>
                            <select name="role" class="form-select" required>
                                <option value="author" selected>Author</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold small text-muted text-uppercase">Bio (Optional)</label>
                            <textarea name="bio" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary px-4">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Author Modal -->
    <div class="modal fade" id="editAuthorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Edit Author Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editAuthorForm">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Full Name</label>
                            <input type="text" name="name" id="editAuthorName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted text-uppercase">Role</label>
                            <select name="role" id="editAuthorRole" class="form-select" required>
                                <option value="author">Author</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold small text-muted text-uppercase">Bio (Publicly
                                visible)</label>
                            <textarea name="bio" id="editAuthorBio" class="form-control" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-secondary px-4">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        async function deleteAuthor(id) {
            if (confirm('Are you sure you want to delete this author? This will not delete their articles, but you should reassign them first.')) {
                try {
                    const response = await fetch(`/admin/authors/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    if (response.ok) {
                        const row = document.getElementById(`row-${id}`);
                        row.style.transition = 'all 0.4s ease';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';
                        setTimeout(() => row.remove(), 400);
                    } else {
                        const data = await response.json();
                        alert('Failed: ' + (data.message || 'Unknown error'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('An error occurred.');
                }
            }
        }

        let currentEditAuthorId = null;

        function openEditAuthorModal(button) {
            const data = JSON.parse(button.dataset.json);
            currentEditAuthorId = data.id;
            document.getElementById('editAuthorName').value = data.name;
            document.getElementById('editAuthorRole').value = data.role;
            document.getElementById('editAuthorBio').value = data.bio;
            const modal = new bootstrap.Modal(document.getElementById('editAuthorModal'));
            modal.show();
        }

        document.getElementById('addAuthorForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/admin/authors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Author account created successfully!');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Failed: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred.');
            }
        });

        document.getElementById('editAuthorForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`/admin/authors/${currentEditAuthorId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Author updated successfully!');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Failed to update: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred while updating the author.');
            }
        });
    </script>

    <%- include('../partials/footer') %>