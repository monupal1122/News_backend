<% const activePage='ads' ; %>
    <%- include('../partials/header') %>

        <div class="container-fluid p-0">
            <%- include('../partials/sidebar', { activePage }) %>

                <main>
                    <header class="main-header mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 fw-bold mb-0">Advertising Management</h1>
                                <p class="text-muted small mb-0">Manage promotional banners and placements</p>
                            </div>
                            <a href="<%= admin.role === 'admin' ? '/admin/ads/create' : '/author/ads/create' %>"
                                class="btn btn-secondary">
                                <i class="bi bi-plus-lg me-2"></i>Create New Ad
                            </a>
                        </div>
                    </header>

                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div
                            class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm fw-semibold px-3">All Ads</button>
                                <button class="btn btn-white btn-sm text-muted px-3">Active</button>
                                <button class="btn btn-white btn-sm text-muted px-3">Paused</button>
                            </div>
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control border-start-0 ps-0"
                                    placeholder="Search ads..." autocomplete="off">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 custom-table">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Preview</th>
                                        <th>Ad Details</th>
                                        <th>Placement</th>
                                        <th>Status</th>
                                        <th>Performance</th>
                                        <th class="pe-4 text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% ads.forEach(ad=> { %>
                                        <tr id="row-<%= ad._id %>">
                                            <td class="ps-4" style="width: 120px;">
                                                <img src="<%= ad.imageUrl || 'https://via.placeholder.com/120x60?text=No+Image' %>"
                                                    class="rounded-2 shadow-sm" width="100" height="50"
                                                    style="object-fit: cover;">
                                            </td>
                                            <td>
                                                <div class="fw-bold text-slate-800 headline-text">
                                                    <%= ad.title %>
                                                </div>
                                                <div class="d-flex align-items-center gap-2 mt-1">
                                                    <small class="text-muted text-truncate" style="max-width: 200px;">
                                                        <i class="bi bi-link-45deg me-1"></i>
                                                        <%= ad.redirectUrl %>
                                                    </small>
                                                </div>
                                                <div class="mt-1">
                                                    <small class="badge bg-light text-primary border-0 px-2 py-1">
                                                        <i class="bi bi-aspect-ratio me-1"></i>
                                                        <%= ad.width || '?' %> x <%= ad.height || '?' %> px
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark border text-capitalize px-3">
                                                    <%= ad.placement %>
                                                </span>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge rounded-pill <%= ad.status === 'active' ? 'bg-success' : 'bg-secondary' %> px-3">
                                                    <%= ad.status.toUpperCase() %>
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column gap-1">
                                                    <small class="text-muted"><i class="bi bi-eye me-1"></i>
                                                        <%= ad.impressions %> Impr.
                                                    </small>
                                                    <small class="text-muted"><i class="bi bi-cursor me-1"></i>
                                                        <%= ad.clicks %> Clicks
                                                    </small>
                                                </div>
                                            </td>
                                            <td class="pe-4 text-end">
                                                <div class="d-flex justify-content-end gap-2">
                                                    <% const editPrefix=admin.role==='admin' ? '/admin' : '/author' ; %>
                                                        <a href="<%= editPrefix %>/ads/edit/<%= ad._id %>"
                                                            class="btn btn-light btn-sm rounded-3 px-3 hover-primary">
                                                            <i class="bi bi-pencil-square me-1"></i> Edit
                                                        </a>
                                                        <button onclick="deleteAd('<%= ad._id %>')"
                                                            class="btn btn-light-danger btn-sm rounded-3 px-3">
                                                            <i class="bi bi-trash-fill"></i>
                                                        </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>

                        <% if(ads.length===0) { %>
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="bi bi-megaphone fs-1 text-muted opacity-25"></i>
                                </div>
                                <h5 class="fw-bold">No ads found</h5>
                                <p class="text-muted">Start by creating your first advertisement banner.</p>
                                <a href="<%= admin.role === 'admin' ? '/admin/ads/create' : '/author/ads/create' %>"
                                    class="btn btn-secondary mt-2">Create Ad</a>
                            </div>
                            <% } %>
                    </div>
                </main>
        </div>

        <style>
            .btn-light-danger {
                background-color: #fff1f2;
                color: #e11d48;
                border: none;
            }

            .btn-light-danger:hover {
                background-color: #ffe4e6;
                color: #be123c;
            }

            .hover-primary:hover {
                background-color: #eff6ff;
                color: #2563eb;
            }

            .text-slate-800 {
                color: #1e293b;
            }
        </style>

        <script>
            async function deleteAd(id) {
                if (confirm('Are you sure you want to delete this advertisement?')) {
                    try {
                        const role = "<%= admin ? admin.role : 'author' %>";
                        const prefix = role === 'admin' ? '/admin' : '/author';
                        const response = await fetch(`${prefix}/ads/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        if (response.ok) {
                            const row = document.getElementById(`row-${id}`);
                            row.style.transition = 'all 0.4s ease';
                            row.style.opacity = '0';
                            row.style.transform = 'translateX(20px)';
                            setTimeout(() => row.remove(), 400);
                        } else {
                            alert('Failed to delete ad. Please try again.');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('An error occurred while deleting the ad.');
                    }
                }
            }
        </script>

        <%- include('../partials/footer') %>